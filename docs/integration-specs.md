# TaskVision 連携機能仕様書

このドキュメントはTaskVisionアプリケーションの連携機能に関する開発仕様書およびチェックリストです。開発の進捗に合わせて更新されます。

## 🔄 開発優先度の変更（重要）

**2023年Q4更新**: 以下の方針変更を行いました：

1. **Firebase無料枠でのリリースを優先**：
   - 静的エクスポート（`output: export`）対応のため、サーバーサイドAPIに依存する統合機能は一時的に凍結
   - 初期リリースではクライアントサイドの機能に集中

2. **開発優先順位**：
   - ✅ **Chrome拡張機能**: 最優先（クライアントサイドから直接使用可能）
   - ⏸️ **Slack連携**: 一時凍結（API Routes依存のため）
   - ⏸️ **メール連携**: 一時凍結（API Routes依存のため）

3. **段階的リリース**：
   - 第1段階: 基本機能 + Chrome拡張機能
   - 第2段階: Vercelなどのホスティングに移行後、API依存の統合機能を追加

## 目次

1. [全体構造](#全体構造)
2. [Chrome拡張機能連携](#chrome拡張機能連携)（最優先）
3. [Slack連携](#slack連携)（凍結中）
4. [メール連携](#メール連携)（凍結中）
5. [セキュリティ対策](#セキュリティ対策)
6. [テスト計画](#テスト計画)
7. [リリース計画](#リリース計画)

## 全体構造

### 実装状況
- [x] 連携機能の基本設計
- [x] 連携設定ページの作成
- [x] 連携タイプの定義（Slack/メール/Chrome拡張）
- [ ] 共通のタスク処理パイプライン
- [ ] ユーザー別の連携設定保存機能

### 仕様詳細

連携機能は以下の3つの主要コンポーネントで構成されます：

1. **外部ソースインターフェース**：外部サービス（Chrome拡張機能、将来的にはSlack、メール）からのデータを受け取る
2. **タスク生成エンジン**：受信したデータからタスク情報を抽出・構造化する
3. **TaskVisionインテグレーター**：生成されたタスクをユーザーのTaskVisionアカウントに追加する

### 開発チェックリスト

- [x] 連携タイプの型定義 (`IntegrationType`)
- [x] サイドバーに連携設定へのリンク追加
- [x] 連携設定ページの基本レイアウト作成
- [ ] クライアントサイドでの連携処理の最適化
- [ ] タスクソース情報のデータベース設計
- [ ] ユーザー別の連携設定データモデル実装
- [ ] 認証フローの実装
- [ ] エラーハンドリング機構の実装

## Chrome拡張機能連携

### 実装状況
- [ ] Chrome拡張機能の基本設計
- [ ] 拡張機能のUI設計
- [ ] バックエンドAPI設計
- [ ] データ同期機能

### 仕様詳細

Chrome拡張機能では、ウェブページからワンクリックでTaskVisionにタスクを追加できるようにします。

1. **拡張機能の機能**
   - ブラウザのツールバーアイコン
   - 右クリックコンテキストメニュー統合
   - 選択テキストからのタスク作成
   - ページタイトルとURLの自動取得

2. **タスク生成ロジック**
   - ページタイトルをデフォルトのタスク名として使用
   - 選択テキスト（あれば）をタスク詳細として使用
   - ページURLをソース情報として保存
   - カスタムフィールド入力UI

3. **認証と同期**
   - TaskVisionアカウントとの連携（Firebase認証連携）
   - ブラウザ間での設定同期
   - オフライン時のキャッシュ機能

### 開発チェックリスト

- [ ] Manifest.jsonファイル作成
- [ ] ポップアップUIの実装
- [ ] コンテキストメニュー機能実装
- [ ] 選択テキスト抽出機能
- [ ] Firebase直接連携機能
- [ ] 認証トークン管理
- [ ] エラーハンドリング
- [ ] Chromeウェブストア公開準備

## Slack連携（⏸️ 一時凍結）

> **注意**: このセクションは将来の実装のために保存されています。現在は静的エクスポート制限のため実装を一時凍結しています。

### 実装状況
- [x] Slack連携設定ページ実装
- [x] Slackメッセージからタスク抽出ロジック実装
- [x] Slackイベント処理のセキュリティ対策実装
- [ ] API Routes対応（Vercelなどでのホスティング後に実装予定）

### 仕様詳細

Slack連携では、指定されたチャンネルのメッセージや特定のリアクションが付いたメッセージを自動的にTaskVisionのタスクに変換します。
※この機能はNext.jsの動的APIルート対応後に実装予定です。

1. **認証フロー**
   - OAuth 2.0を使用してSlackワークスペースと連携
   - ユーザーがTaskVisionアプリをSlackワークスペースにインストール
   - ボットトークンを安全に保存

2. **タスク抽出ロジック**
   - 特定のリアクション（例：✅）が付いたメッセージをタスクに変換
   - メッセージの最初の行をタスク名として使用
   - メッセージの残りをタスク詳細として使用
   - メッセージURLをタスクのソース情報として保存

3. **ユーザー設定オプション**
   - 監視するチャンネルのリスト
   - トリガーとなるリアクションの種類
   - デフォルトの期限設定（今日/明日/未設定）

### 開発チェックリスト（凍結中）

- [x] Slack APIアプリ作成
- [x] Botトークン取得機能
- [x] イベント購読設定
- [x] メッセージ処理ウェブフック実装
- [x] リアクション検出機能
- [x] タスク変換ロジック実装
- [x] ユーザー設定インターフェース実装
- [ ] 動的APIルート対応（将来）

## メール連携（⏸️ 一時凍結）

> **注意**: このセクションは将来の実装のために保存されています。現在は静的エクスポート制限のため実装を一時凍結しています。

### 実装状況
- [ ] メール受信システム設計
- [ ] メール解析ロジック
- [ ] 添付ファイル処理
- [ ] スパム対策

### 仕様詳細

メール連携では、専用のメールアドレスに送信されたメールを自動的にTaskVisionのタスクに変換します。
※この機能はNext.jsの動的APIルート対応後に実装予定です。

1. **メール受信システム**
   - SendGrid/Mailgunなどのサービスを使用したInbound Email処理
   - 専用メールアドレスの提供（例：username.tasks@taskvision.app）

2. **タスク抽出ロジック**
   - 件名をタスク名として使用
   - 本文をタスク詳細として使用
   - 差出人情報をソース情報として保存
   - メールに記載された日付（あれば）を期限として解析

3. **ユーザー設定オプション**
   - 許可する送信者リスト
   - キーワードベースのフィルタリング
   - 添付ファイルの処理方法（保存/無視）

### 開発チェックリスト（凍結中）

- [ ] メール処理サービスの選定と設定
- [ ] Inbound Parse Webhook実装
- [ ] メール解析ロジック開発
- [ ] HTMLからテキスト抽出機能
- [ ] 日付抽出アルゴリズム実装
- [ ] 送信者検証システム
- [ ] フィルタリングルール実装
- [ ] 添付ファイル処理機能（オプション）

## セキュリティ対策

### 実装状況
- [x] Firebase認証の適用
- [ ] Chrome拡張機能用のセキュリティトークン設計
- [ ] データ検証ルールの実装
- [ ] レート制限の実装

### 仕様詳細

1. **認証セキュリティ**
   - Firebaseの認証システムを活用
   - トークンの適切な管理
   - 最小権限原則の適用

2. **データ検証**
   - 入力データのサニタイズ
   - 悪意あるコンテンツのフィルタリング
   - サイズ制限の実装

3. **クライアントサイドセキュリティ**
   - Chrome拡張機能認証の確保
   - クロスサイトスクリプティング対策
   - セキュアなデータ保存

### 開発チェックリスト

- [x] Firebase認証
- [ ] Chrome拡張機能認証フロー実装
- [ ] 入力検証ミドルウェア実装
- [ ] セキュリティヘッダー設定
- [ ] ロギングシステム実装
- [ ] セキュリティレビュー実施

## テスト計画

### 実装状況
- [ ] テスト戦略の策定
- [ ] 単体テストケース作成
- [ ] 統合テストケース作成

### テスト項目

1. **単体テスト**
   - データ解析ロジック
   - タスク生成ルール
   - フィルタリングルール

2. **統合テスト**
   - Chrome拡張機能との通信
   - Firebaseとの連携
   - ユーザー認証フロー

3. **エンドツーエンドテスト**
   - Chrome拡張機能からのタスク作成
   - 実際のウェブページからのデータ取得
   - オフライン動作検証

### 開発チェックリスト

- [ ] テストフレームワーク設定
- [ ] モックデータ作成
- [ ] CIパイプライン統合
- [ ] テストカバレッジ目標設定（>80%）
- [ ] 手動テスト手順書作成
- [ ] パフォーマンステスト実施

## リリース計画

### フェーズ1: 基本機能リリース
- 目標日: 2023年Q4
- 主要機能: タスク管理の基本機能
- ホスティング: Firebase Hosting (静的エクスポート)
- ターゲット: 限定的なβテスター

### フェーズ2: Chrome拡張機能リリース
- 目標日: 2024年Q1
- 主要機能: ウェブページからのタスク作成
- Chromeウェブストアでの公開
- ターゲット: 生産性向上ツールを求めるユーザー

### フェーズ3: ホスティング移行と機能拡張
- 目標日: 2024年Q2
- 移行先: Vercelなどの動的APIルート対応ホスティング
- 新機能: Slack連携の有効化
- ターゲット: チーム利用を求めるユーザー

### フェーズ4: 完全統合版リリース
- 目標日: 2024年Q3
- 主要機能: すべての連携機能（Slack、メール、Chrome）
- 高度なフィルタリング、AIによるタスク分類
- API公開とサードパーティ連携 