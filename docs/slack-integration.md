# Slack連携機能の実装

## ⚠️ 重要なお知らせ: 機能の一時凍結について

**2023年Q4更新**: 
Firebaseの静的ホスティング (`output: export`) での初期リリース優先のため、Slack連携機能は一時的に凍結されています。この機能はサーバーサイドAPIルートに依存するため、Vercelなどの完全なNext.js機能をサポートするホスティングに移行後に実装される予定です。

現在の開発優先順位:
1. **基本機能**: タスク管理の中核機能
2. **Chrome拡張機能**: クライアントサイドから直接使用可能な統合機能
3. ~~Slack連携~~: 一時凍結 (2024年Q2頃の再開を予定)

以下の内容はリファレンスとして保存されています。

## 概要

TaskVisionアプリケーションとSlackを連携するための機能を実装しました。この連携により、Slackメッセージに特定のリアクションが付けられた場合やマーカー（例：`#task`）が含まれるメッセージが投稿された場合に、自動的にTaskVisionにタスクとして登録されます。

**注意**: この機能はSlack → TaskVisionの単方向連携のみをサポートしています。TaskVisionからSlackへの通知機能やスラッシュコマンドは実装されていません。

## 実装された主要機能

1. **Slack設定ページ**
   - ユーザーがSlack連携の設定を行うためのUI
   - Slackワークスペース、Botトークン、監視対象チャンネル、トリガーリアクションの設定
   - 設定のバリデーションと保存

2. **Webhook処理**
   - SlackからのイベントをキャッチするAPIエンドポイント
   - リクエスト署名の検証によるセキュリティ対策
   - イベントタイプに応じた処理の振り分け

3. **イベント処理**
   - リアクション追加イベントの処理
   - メッセージイベントの処理
   - タスク生成ロジック

4. **セキュリティ対策**
   - Slack署名の検証によるなりすまし防止
   - トークンの暗号化保存
   - タイミング攻撃対策
   - リプレイ攻撃対策（古いリクエストの拒否）

## ファイル構成

```
src/
├── app/
│   ├── api/
│   │   └── integrations/
│   │       └── slack/
│   │           └── webhook/
│   │               └── route.ts       # Slackからのwebhookを処理するAPI
│   └── integrations/
│       └── setup/
│           └── slack/
│               └── page.tsx           # Slack連携設定ページ
├── lib/
│   ├── encryption.ts                  # 暗号化ユーティリティ
│   ├── logger.ts                      # ロガー
│   └── integrations/
│       ├── integrationUtils.ts        # 共通の統合ユーティリティ
│       ├── slackIntegration.ts        # Slack APIとやり取りするユーティリティ
│       └── slackEventProcessor.ts     # Slackイベントを処理するユーティリティ
└── types.ts                           # 型定義（SlackEvent, SlackIntegrationなど）
```

## セットアップ手順

Slack連携を利用するには、以下の手順が必要です：

1. [Slack API](https://api.slack.com/apps)でSlackアプリを作成
2. 以下の権限スコープを追加:
   - `channels:history`
   - `reactions:read`
   - `chat:write`
3. イベント購読を設定:
   - `message.channels`
   - `reaction_added`
4. イベント購読URLとして、TaskVisionのWebhookエンドポイントを設定
5. Botトークンを取得し、TaskVisionの連携設定画面に入力

## セキュリティに関する注意事項

1. **シークレットの管理**:
   - 環境変数 `SLACK_SIGNING_SECRET` と `ENCRYPTION_KEY` を適切に設定する
   - 本番環境では強力なランダム文字列を使用する

2. **トークンの保護**:
   - Slackトークンは暗号化して保存
   - 定期的なトークンローテーションを推奨

3. **リクエスト検証**:
   - すべてのSlackリクエストに対して署名検証を実行
   - 5分以上経過したリクエストは拒否（リプレイ攻撃対策）

## 今後の拡張予定

1. **テスト強化**:
   - ユニットテストの追加
   - エンドツーエンドテストの実装

2. **ユーザーエクスペリエンスの改善**:
   - より分かりやすいエラーメッセージ
   - 設定画面のユーザビリティ向上

3. **カスタマイズオプション**:
   - タスクテンプレートのカスタマイズ
   - より柔軟なフィルタリングオプション

## 技術的な課題と解決策

1. **非同期処理**:
   - Slackは3秒以内のレスポンスを要求するため、イベント処理を非同期で実行
   - バックグラウンドでタスク作成を行い、即時にACKを返す

2. **レート制限**:
   - Slack APIのレート制限に対応するための対策
   - エラー時の適切なバックオフとリトライ

3. **エラーハンドリング**:
   - エラーログの適切な記録
   - ユーザーへのわかりやすいエラーメッセージ表示 